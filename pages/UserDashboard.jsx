import React from "react";
import { useNavigate } from "react-router-dom";
import Button from "../components/common/Button";
import Avatar from "../components/common/Avatar";
import Card from "../components/common/Card";
import { useAuth, useFoodListings, useNotifications } from "../utils/hooks/useSupabase";
import supabase from "../utils/supabaseClient";

// Helper function for date formatting
const formatDate = (date) => {
    if (!date) return '';
    return new Date(date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

function UserDashboard() {
    const navigate = useNavigate();
    const { user: authUser, isAuthenticated } = useAuth();
    const { listings: userListings, loading: listingsLoading, error: listingsError } = useFoodListings({ user_id: authUser?.id });
    const { notifications, loading: notificationsLoading, error: notificationsError } = useNotifications(authUser?.id);

    const [foodClaims, setFoodClaims] = React.useState([]);
    const [claimsLoading, setClaimsLoading] = React.useState(true);
    const [updatingClaim, setUpdatingClaim] = React.useState(null);

    const loading = listingsLoading || notificationsLoading || claimsLoading;
    const error = listingsError || notificationsError;
    const user = authUser;

    React.useEffect(() => {
        if (authUser?.id) {
            fetchFoodClaims();
        }
    }, [authUser?.id]);

    const fetchFoodClaims = async () => {
        try {
            setClaimsLoading(true);

            const { data: claims, error: claimsError } = await supabase
                .from('food_claims')
                .select(`
                    *,
                    food_listings (
                        id,
                        title,
                        description,
                        image_url,
                        quantity,
                        unit,
                        category,
                        pickup_location
                    )
                `)
                .eq('claimer_id', authUser.id)
                .order('created_at', { ascending: false });

            if (claimsError) throw claimsError;

            setFoodClaims(claims || []);
        } catch (err) {
            console.error('Error fetching food claims:', err);
        } finally {
            setClaimsLoading(false);
        }
    };

    const handleMarkPickedUp = async (claimId) => {
        try {
            setUpdatingClaim(claimId);

            const { error: updateError } = await supabase
                .from('food_claims')
                .update({ status: 'completed' })
                .eq('id', claimId);

            if (updateError) throw updateError;

            // Update local state
            setFoodClaims(prev => 
                prev.map(claim => 
                    claim.id === claimId 
                        ? { ...claim, status: 'completed' }
                        : claim
                )
            );
        } catch (err) {
            console.error('Error updating claim status:', err);
        } finally {
            setUpdatingClaim(null);
        }
    };
    const recentActivity = React.useMemo(() => {
        if (!userListings) return [];
        
        const activities = userListings.map(listing => ({
            type: 'listing_created',
            title: 'New Listing Created',
            description: `You listed "${listing.title}" for sharing`,
            time: formatDate(listing.created_at),
            icon: 'fa-plus-circle',
            iconColor: 'text-[#2CABE3]'
        })).sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 5);

        return activities;
    }, [userListings]);

    // Quick actions
    const quickActions = [
        /* TEMPORARILY DISABLED
        {
            title: 'Share Food',
            description: 'Share your surplus food',
            icon: 'fa-plus',
            path: '/share',
            color: 'bg-[#2CABE3]'
        },
        */
        {
            title: 'Find Food',
            description: 'Browse available items',
            icon: 'fa-search',
            path: '/find',
            color: 'bg-blue-500'
        },
        {
            title: 'Donation Schedules',
            description: 'Set up recurring donations',
            icon: 'fa-calendar',
            path: '/donations',
            color: 'bg-purple-500'
        }
    ];

    // Calculate notifications from Supabase data
    const dashboardNotifications = React.useMemo(() => {
        if (!userListings) return [];
        
        return userListings
            .filter(listing => {
                const daysUntilExpiry = Math.ceil(
                    (new Date(listing.expiry_date) - new Date()) / (1000 * 60 * 60 * 24)
                );
                return daysUntilExpiry <= 3 && daysUntilExpiry > 0;
            })
            .map(listing => ({
                title: 'Listing Expiring Soon',
                message: `Your listing "${listing.title}" expires in ${Math.ceil(
                    (new Date(listing.expiry_date) - new Date()) / (1000 * 60 * 60 * 24)
                )} days`,
                time: formatDate(new Date()),
                read: false,
                type: 'warning'
            }));
    }, [userListings]);

    if (loading) {
        return (
            <div className="max-w-7xl mx-auto py-8 px-4" role="status" aria-busy="true">
                <div className="sr-only">Loading dashboard data...</div>
                <div className="animate-pulse space-y-8">
                    <div className="h-32 bg-gray-200 rounded-lg"></div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        {[1, 2, 3, 4].map(i => (
                            <div key={i} className="h-24 bg-gray-200 rounded-lg"></div>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="h-64 bg-gray-200 rounded-lg"></div>
                        <div className="h-64 bg-gray-200 rounded-lg"></div>
                    </div>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="max-w-7xl mx-auto py-8 px-4 text-center" role="alert">
                <i className="fas fa-exclamation-circle text-red-500 text-4xl mb-4" aria-hidden="true"></i>
                <p className="text-gray-600 mb-4">{error.message || 'An unexpected error occurred.'}</p>
                <Button
                    variant="secondary"
                    onClick={() => window.location.reload()}
                    aria-label="Retry loading dashboard data"
                >
                    Try Again
                </Button>
            </div>
        );
    }

    const handleQuickAction = (path) => {
        navigate(path);
    };

    return (
        <div className="max-w-7xl mx-auto py-8 px-4">
            {/* Welcome Section */}
            <div className="bg-white rounded-lg shadow-sm p-6 mb-8" role="banner">
                <div className="flex items-center">
                    <Avatar 
                        src={user?.avatar} 
                        size="xl" 
                        alt={`${user?.name}'s avatar`}
                    />
                    <div className="ml-6">
                        <div className="flex items-center gap-3">
                            <h1 className="text-2xl font-bold text-gray-900">
                                Welcome back, {user?.name}!
                            </h1>
                        </div>
                        <p className="text-gray-600">
                            Here's what's happening with your food sharing activities
                        </p>
                    </div>
                </div>
            </div>

            {/* Food Receipts Section */}
            <div className="mb-8" role="region" aria-label="Food Claim Receipts">
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Your Food Receipts</h2>
                
                {claimsLoading ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {[1, 2, 3].map(i => (
                            <div key={i} className="animate-pulse bg-gray-200 rounded-lg h-64"></div>
                        ))}
                    </div>
                ) : foodClaims.length > 0 ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {foodClaims.map((claim) => (
                            <div 
                                key={claim.id} 
                                className="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-shadow"
                                role="article"
                            >
                                {/* Food Image */}
                                {claim.food_listings?.image_url && (
                                    <div className="h-48 overflow-hidden">
                                        <img 
                                            src={claim.food_listings.image_url} 
                                            alt={claim.food_listings.title}
                                            className="w-full h-full object-cover"
                                        />
                                    </div>
                                )}
                                
                                {/* Receipt Details */}
                                <div className="p-4">
                                    <h3 className="text-lg font-semibold text-gray-900 mb-2">
                                        {claim.food_listings?.title || 'Food Item'}
                                    </h3>
                                    
                                    {claim.food_listings?.category && (
                                        <span className="inline-block px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded mb-2">
                                            {claim.food_listings.category}
                                        </span>
                                    )}
                                    
                                    {claim.food_listings?.quantity && (
                                        <p className="text-sm text-gray-600 mb-2">
                                            <i className="fas fa-weight-scale mr-2" aria-hidden="true"></i>
                                            Quantity: {claim.food_listings.quantity} {claim.food_listings.unit || ''}
                                        </p>
                                    )}
                                    
                                    {claim.food_listings?.pickup_location && (
                                        <p className="text-sm text-gray-600 mb-2">
                                            <i className="fas fa-map-marker-alt mr-2" aria-hidden="true"></i>
                                            {claim.food_listings.pickup_location}
                                        </p>
                                    )}
                                    
                                    <p className="text-xs text-gray-400 mb-4">
                                        Claimed: {formatDate(claim.created_at)}
                                    </p>
                                    
                                    {/* Status Button */}
                                    {claim.status === 'completed' ? (
                                        <button
                                            disabled
                                            className="w-full py-2 px-4 bg-gray-300 text-gray-600 rounded-lg font-medium cursor-not-allowed"
                                            aria-label="Food pickup completed"
                                        >
                                            <i className="fas fa-check-circle mr-2" aria-hidden="true"></i>
                                            Complete
                                        </button>
                                    ) : (
                                        <button
                                            onClick={() => handleMarkPickedUp(claim.id)}
                                            disabled={updatingClaim === claim.id}
                                            className="w-full py-2 px-4 bg-[#2CABE3] text-white rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50"
                                            aria-label="Mark as picked up"
                                        >
                                            {updatingClaim === claim.id ? (
                                                <>
                                                    <i className="fas fa-spinner fa-spin mr-2" aria-hidden="true"></i>
                                                    Updating...
                                                </>
                                            ) : (
                                                <>
                                                    <i className="fas fa-hand-holding-heart mr-2" aria-hidden="true"></i>
                                                    Picked Up
                                                </>
                                            )}
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="bg-white rounded-lg shadow-sm p-12 text-center">
                        <i className="fas fa-receipt text-gray-400 text-5xl mb-4" aria-hidden="true"></i>
                        <h3 className="text-xl font-semibold text-gray-900 mb-2">No Food Claims Yet</h3>
                        <p className="text-gray-600 mb-6">
                            Start claiming food from your community to see your receipts here.
                        </p>
                        <Button
                            variant="primary"
                            onClick={() => navigate('/find')}
                            aria-label="Find available food"
                        >
                            <i className="fas fa-search mr-2" aria-hidden="true"></i>
                            Find Food
                        </Button>
                    </div>
                )}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Quick Actions */}
                <div className="space-y-6">
                    <h2 className="text-lg font-semibold text-gray-900">Quick Actions</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4" role="navigation">
                        {quickActions.map((action, index) => (
                            <button
                                key={index}
                                onClick={() => handleQuickAction(action.path)}
                                className="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow"
                                aria-label={`${action.title}: ${action.description}`}
                            >
                                <div className="flex items-center">
                                    <div className={`w-10 h-10 rounded-full ${action.color} flex items-center justify-center`}>
                                        <i className={`fas ${action.icon} text-white`} aria-hidden="true"></i>
                                    </div>
                                    <div className="ml-4 text-left">
                                        <h3 className="font-medium text-gray-900">{action.title}</h3>
                                        <p className="text-sm text-gray-500">{action.description}</p>
                                    </div>
                                </div>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Recent Activities */}
                <div className="space-y-6">
                    <h2 className="text-lg font-semibold text-gray-900">Recent Activities</h2>
                    <Card>
                        <div className="divide-y divide-gray-200" role="feed" aria-label="Recent activities">
                            {recentActivity.length > 0 ? (
                                recentActivity.map((activity, index) => (
                                    <div key={index} className="p-4" role="article">
                                        <div className="flex items-start">
                                            <div className={`mt-1 ${activity.iconColor}`}>
                                                <i className={`fas ${activity.icon}`} aria-hidden="true"></i>
                                            </div>
                                            <div className="ml-3">
                                                <p className="text-sm font-medium text-gray-900">
                                                    {activity.title}
                                                </p>
                                                <p className="text-sm text-gray-500">
                                                    {activity.description}
                                                </p>
                                                <p className="text-xs text-gray-400 mt-1">
                                                    {activity.time}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="p-4 text-center text-gray-500" role="status">
                                    No recent activities
                                </div>
                            )}
                        </div>
                    </Card>
                </div>
            </div>

            {/* Notifications */}
            {notifications.length > 0 && (
                <div className="mt-8" role="complementary" aria-label="Notifications">
                    <h2 className="text-lg font-semibold text-gray-900 mb-6">Notifications</h2>
                    <div className="space-y-4">
                        {notifications.map((notification, index) => (
                            <Card key={index}>
                                <div className="p-4" role="alert">
                                    <div className="flex items-start">
                                        <div className="flex-shrink-0">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                                notification.type === 'warning' ? 'bg-yellow-100' : 'bg-blue-100'
                                            }`}>
                                                <i className={`fas ${
                                                    notification.type === 'warning' ? 'fa-exclamation-triangle text-yellow-600' : 'fa-handshake text-blue-600'
                                                }`} aria-hidden="true"></i>
                                            </div>
                                        </div>
                                        <div className="ml-3 flex-1">
                                            <p className="text-sm font-medium text-gray-900">
                                                {notification.title}
                                            </p>
                                            <p className="mt-1 text-sm text-gray-500">
                                                {notification.message}
                                            </p>
                                            <p className="mt-1 text-xs text-gray-400">
                                                {notification.time}
                                            </p>
                                        </div>
                                        {!notification.read && (
                                            <div className="ml-3">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    New
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}

export default UserDashboard;